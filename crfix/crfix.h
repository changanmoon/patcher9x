/******************************************************************************
 * MIT No Attribution
 *
 * Copyright 2025 Jaroslav Hensl <emulator@emulace.cz>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
*******************************************************************************/
#ifndef __PATCHER9X__CRFIX_H__INCLUDED__
#define __PATCHER9X__CRFIX_H__INCLUDED__

/* fasm: wincomfix.asm */
#if 0
static const uint8_t crfix_code[] = {
	0x50,0x41,0x54,0x43,0x48,0x00,0x89,0xFF,0x66,0x50,0x66,0x51,0x66,0x52,0x0F,0x01, // PATCH.‰ÿfPfQfR..
	0xE0,0x66,0x83,0xE0,0x01,0x75,0x3A,0x0F,0x20,0xC0,0x66,0x25,0x3F,0x00,0x05,0xE0, // àfƒà.u:. Àf%?..à
	0x0F,0x22,0xC0,0x66,0x31,0xC0,0x0F,0x22,0xD0,0x0F,0x22,0xD8,0x0F,0x20,0xE0,0x66, // ."Àf1À."Ð."Ø. àf
	0x25,0x07,0x02,0x04,0x00,0x0F,0x22,0xE0,0x66,0x31,0xC0,0x66,0x31,0xD2,0x66,0xB9, // %....."àf1Àf1Òf¹
	0x80,0x00,0x00,0xC0,0x0F,0x30,0xE8,0x00,0x00,0x5A,0x83,0xC2,0x10,0xB4,0x09,0xCD, // €..À.0è..ZƒÂ.´.Í
	0x21,0x66,0x5A,0x66,0x58,0x66,0x58,0xEB,0x34,0x28,0x50,0x61,0x74,0x63,0x68,0x65, // !fZfXfXë4(Patche
	0x72,0x39,0x78,0x29,0x20,0x43,0x6F,0x6E,0x74,0x72,0x6F,0x6C,0x20,0x52,0x65,0x67, // r9x) Control Reg
	0x69,0x73,0x74,0x65,0x72,0x73,0x20,0x61,0x72,0x65,0x20,0x63,0x6C,0x65,0x61,0x6E, // isters are clean
	0x21,0x0D,0x0A,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE9,0x00,0x00, // !..$.........é..
};
#endif
static const uint8_t crfix_code[] = {
	0x50,0x41,0x54,0x43,0x48,0x01,0x89,0xFF,0x66,0x50,0x66,0x51,0x66,0x52,0x66,0x53,
	0x0F,0x01,0xE0,0x66,0x83,0xE0,0x01,0x0F,0x85,0x96,0x00,0x66,0x9C,0x66,0x58,0x66,
	0x89,0xC3,0x66,0x35,0x00,0x00,0x20,0x00,0x66,0x50,0x66,0x9D,0x66,0x9C,0x66,0x58,
	0x66,0x39,0xD8,0x74,0x7C,0x0F,0x20,0xC0,0x66,0x25,0x3F,0x00,0x05,0xE0,0x0F,0x22,
	0xC0,0x66,0x31,0xC0,0x0F,0x22,0xD0,0x0F,0x22,0xD8,0x0F,0x20,0xE0,0x66,0x25,0x07,
	0x02,0x04,0x00,0x0F,0x22,0xE0,0x66,0x31,0xC0,0x0F,0xA2,0x66,0x83,0xF8,0x02,0x7C,
	0x45,0x66,0xB8,0x01,0x00,0x00,0x00,0x0F,0xA2,0x66,0xF7,0xC2,0x20,0x00,0x00,0x00,
	0x74,0x34,0x66,0xB8,0x01,0x00,0x00,0x80,0x0F,0xA2,0x66,0xF7,0xC2,0x00,0x00,0x00,
	0x20,0x74,0x23,0x66,0x31,0xC0,0x66,0x31,0xD2,0x66,0xB9,0x80,0x00,0x00,0xC0,0x0F,
	0x30,0xE8,0x00,0x00,0x5B,0x83,0xC3,0x3D,0x2E,0xC6,0x07,0x20,0x2E,0xC6,0x47,0x01,
	0x2B,0x2E,0xC6,0x47,0x02,0x20,0xE8,0x00,0x00,0x5A,0x83,0xC2,0x12,0xB4,0x09,0xCD,
	0x21,0x66,0x5B,0x66,0x5A,0x66,0x58,0x66,0x58,0xEB,0x22,0x77,0x69,0x6E,0x2E,0x63,
	0x6F,0x6D,0x3A,0x20,0x72,0x65,0x73,0x65,0x74,0x20,0x43,0x52,0x30,0x2D,0x43,0x52,
	0x34,0x0D,0x0A,0x24,0x4D,0x53,0x52,0x0D,0x0A,0x24,0x00,0x00,0x00,0xE9,0x00,0x00,
};
/* ^last 3 bytes are relative jump to original code, code starts at 6 */

#define CRFIX_CODE_START 6
#define CRFIX_CHECK_BYTES 5
#define CRFIX_JMP_POS (sizeof(crfix_code)-3)

#define X86_JMP 0xE9

#define COM_ORG 0x100

#define JMP_TO_FILEOFF(_j) ((_j)-COM_ORG)
#define JMP_TO_INST16_OFF(_j, _a) (((_j)-((_a) + 3))&0xFFFF)

/* current patch revision */
#define CRFIX_REV 1

/* for update... */
#define CRFIX_REV0 0
#define CRFIX_REV0_SIZE 144

#endif /* __PATCHER9X__CRFIX_H__INCLUDED__ */
